services:
  # Nginx Web Server
  nginx-web:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
    container_name: onionforge-nginx
    restart: unless-stopped
    volumes:
      - ./src:/usr/share/nginx/html:ro
      - nginx-logs:/var/log/nginx
    networks:
      - onion-network
    expose:
      - "80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health-check.html"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.onionforge.service=web"
      - "com.onionforge.description=Static web server"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Tor Hidden Service
  tor-service:
    build:
      context: .
      dockerfile: docker/tor/Dockerfile
    container_name: onionforge-tor
    restart: unless-stopped
    depends_on:
      - nginx-web
    volumes:
      - tor-data:/var/lib/tor
      - ./docker/tor/torrc:/etc/tor/torrc:ro
      - tor-logs:/var/log/tor
    networks:
      - onion-network
    # No ports exposed by default for security
    healthcheck:
      test: ["CMD-SHELL", "curl -s --socks5-hostname localhost:9050 https://check.torproject.org/ | grep -q 'Congratulations' || exit 1"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 40s
    labels:
      - "com.onionforge.service=tor"
      - "com.onionforge.description=Tor hidden service"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    init: true  # Give Tor time to start up

networks:
  onion-network:
    name: onionforge-network
    driver: bridge

volumes:
  tor-data:
    name: onionforge-tor-data
  nginx-logs:
    name: onionforge-nginx-logs
  tor-logs:
    name: onionforge-tor-logs